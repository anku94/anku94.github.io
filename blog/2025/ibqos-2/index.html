<!DOCTYPE html> <html lang="en"> <head> <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"> <meta name="google-site-verification" content="3ec0Ti5C7XRZ9uYFYQwJWhUPAB4Hr4GvDqj1HRAcSFg"> <meta http-equiv="Permissions-Policy" content="interest-cohort=()"> <meta charset="utf-8"> <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <title>QoS In Infiniband Via RDMA-CM | Ankush Jain</title> <meta name="author" content="Ankush Jain"> <meta name="description" content="Configuring QoS on IB via RDMA-CM"> <meta name="keywords" content="systems, hpc, storage, networks, performance, linux"> <link href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha256-DF7Zhf293AJxJNTmh5zhoYYIMs2oXitRfBjY+9L//AY=" crossorigin="anonymous"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/css/mdb.min.css" integrity="sha256-jpjYvU3G3N6nrrBwXJoVEYI/0zw8htfFnhT9ljN3JJw=" crossorigin="anonymous"> <link defer rel="stylesheet" href="https://unpkg.com/bootstrap-table@1.21.4/dist/bootstrap-table.min.css"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" integrity="sha256-HtsXJanqjKTc8vVQjO4YMhiqFoXkfBsjBWcX91T1jr8=" crossorigin="anonymous"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/academicons@1.9.1/css/academicons.min.css" integrity="sha256-i1+4qU2G2860dGGIOJscdC30s9beBXjFfzjWLjBRsBg=" crossorigin="anonymous"> <link rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700|Roboto+Slab:100,300,400,500,700|Material+Icons"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/jwarby/jekyll-pygments-themes@master/github.css" media="" id="highlight_theme_light"> <link rel="shortcut icon" href="/assets/img/favicon.ico"> <link rel="stylesheet" href="/assets/css/main.css?d41d8cd98f00b204e9800998ecf8427e"> <link rel="canonical" href="https://ankushja.in/blog/2025/ibqos-2/"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/jwarby/jekyll-pygments-themes@master/monokai.css" media="none" id="highlight_theme_dark"> <script src="/assets/js/theme.js?96d6b3e1c3604aca8b6134c7afdd5db6"></script> <script src="/assets/js/dark_mode.js?9b17307bb950ffa2e34be0227f53558f"></script> </head> <body class="fixed-top-nav "> <header> <nav id="navbar" class="navbar navbar-light navbar-expand-sm fixed-top"> <div class="container"> <a class="navbar-brand title font-weight-lighter" href="/">Ankush Jain</a> <button class="navbar-toggler collapsed ml-auto" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation"> <span class="sr-only">Toggle navigation</span> <span class="icon-bar top-bar"></span> <span class="icon-bar middle-bar"></span> <span class="icon-bar bottom-bar"></span> </button> <div class="collapse navbar-collapse text-right" id="navbarNav"> <ul class="navbar-nav ml-auto flex-nowrap"> <li class="nav-item "> <a class="nav-link" href="/">about</a> </li> <li class="nav-item active"> <a class="nav-link" href="/blog/">blog<span class="sr-only">(current)</span></a> </li> <li class="nav-item "> <a class="nav-link" href="/projects/">projects</a> </li> <li class="nav-item "> <a class="nav-link" href="/cv/">cv</a> </li> <li class="toggle-container"> <button id="light-toggle" title="Change theme"> <i class="fas fa-moon"></i> <i class="fas fa-sun"></i> </button> </li> </ul> </div> </div> </nav> <progress id="progress" value="0"> <div class="progress-container"> <span class="progress-bar"></span> </div> </progress> </header> <div class="container mt-5"> <div class="post"> <header class="post-header"> <h1 class="post-title">QoS In Infiniband Via RDMA-CM</h1> <p class="post-meta">September 23, 2025</p> <p class="post-tags"> <a href="/blog/2025"> <i class="fas fa-calendar fa-sm"></i> 2025 </a>   ·   <a href="/blog/tag/infiniband"> <i class="fas fa-hashtag fa-sm"></i> infiniband</a>   <a href="/blog/tag/qos"> <i class="fas fa-hashtag fa-sm"></i> qos</a>     ·   <a href="/blog/category/infiniband"> <i class="fas fa-tag fa-sm"></i> infiniband</a>   </p> </header> <article class="post-content"> <div id="markdown-content"> <p><em>Note: this entire post is a lightly edited checkpoint of a conversation with some LLM.</em> <a href="https://ankushja.in/blog/2025/ibqos/">Part 1</a> here.</p> <h2 id="introduction">Introduction</h2> <p>RDMA-CM (RDMA Connection Manager) is the control-plane layer for RDMA. It exists to make connection setup look and feel like sockets: applications can bind to addresses, listen on ports, and accept or connect without worrying about raw InfiniBand identifiers. Underneath, RDMA-CM exchanges the connection metadata, programs the QPs, and hands back an endpoint ready for verbs. This is distinct from the verbs API, which only covers the data plane.</p> <h2 id="background-qos-in-infiniband">Background: QoS in InfiniBand</h2> <p>InfiniBand provides Quality of Service using <strong>Service Levels (SLs)</strong>. An SL is a small integer carried in each packet’s header. The subnet manager maps SLs onto <strong>Virtual Lanes (VLs)</strong>, which are independent link-level flows with separate buffering and flow control. By assigning flows to different SLs, the fabric can prioritize some traffic or keep classes of traffic from interfering with each other. SL is selected when a QP is created, and remains fixed for that QP’s traffic.</p> <h2 id="rdma-cm-basics">RDMA-CM Basics</h2> <p>RDMA-CM exposes a socket-like API:</p> <ul> <li> <p>The central handle is an <code class="language-plaintext highlighter-rouge">rdma_cm_id</code>, analogous to a socket fd.</p> </li> <li> <p>Each cm_id belongs to a <strong>port space</strong>, such as <code class="language-plaintext highlighter-rouge">RDMA_PS_TCP</code> (connection-oriented) or <code class="language-plaintext highlighter-rouge">RDMA_PS_UDP</code> (datagrams).</p> </li> <li> <p>Applications use <code class="language-plaintext highlighter-rouge">rdma_bind_addr</code>, <code class="language-plaintext highlighter-rouge">rdma_listen</code>, <code class="language-plaintext highlighter-rouge">rdma_connect</code>, etc., in the same way they would with sockets.</p> </li> </ul> <p>What looks like an IP+port pair in RDMA-CM is just a wrapper. With IPoIB enabled, the “IP” is the interface address (e.g. <code class="language-plaintext highlighter-rouge">10.94.3.105</code>), which RDMA-CM resolves to a GID. Without IPoIB, you still can create connections, but the address is directly a GID (usually expressed in IPv6 link-local form). In both cases, the binding resolves to a specific HCA port and GID.</p> <p>The handshake itself is a control-plane exchange: on InfiniBand it uses CM MADs over QP1, on RoCE/iWARP it uses UDP/TCP messages. This is how QP numbers, PSNs, MTU, and SL hints are exchanged.</p> <h2 id="rdma-cm-and-service-ids">RDMA-CM and Service IDs</h2> <p>The key to QoS integration is that RDMA-CM maps the familiar notion of <strong>port numbers</strong> into InfiniBand <strong>Service IDs</strong>. A Service ID is a 64‑bit identifier that the Subnet Manager understands. In <code class="language-plaintext highlighter-rouge">RDMA_PS_TCP</code>, the port number you bind is encoded into the Service ID automatically. This provides a clean classification hook: flows created on different port ranges correspond to different Service IDs.</p> <h2 id="subnet-manager-qos-policies--setup-opensm">Subnet Manager QoS Policies &amp; Setup (OpenSM)</h2> <p>OpenSM can enforce QoS by mapping <strong>Service IDs</strong> (derived from RDMA-CM port numbers) to <strong>Service Levels (SLs)</strong> and then to <strong>Virtual Lanes (VLs)</strong>.</p> <h3 id="1-enable-qos-in-opensm">1) Enable QoS in OpenSM</h3> <p>Edit <code class="language-plaintext highlighter-rouge">/etc/opensm/opensm.conf</code> (or the file you pass with <code class="language-plaintext highlighter-rouge">-f</code>) and set:</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>qos TRUE
qos_max_vls 8              # adjust to your ASIC/link support (e.g., 4 or 8)
qos_policy_file /etc/opensm/qos-policy.conf
</code></pre></div></div> <p>You may additionally pin SL→VL and VL arbitration globally here if you want static tables in the options file (advanced fabrics often keep these in the policy file instead).</p> <p>Restart or start OpenSM with QoS active:</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>systemctl restart opensm    # distro services
# or manually
opensm -Q -f /etc/opensm/opensm.conf
# (-Q/--qos is equivalent to qos TRUE; -Y sets an explicit policy file path)
</code></pre></div></div> <h3 id="2-define-qos-policy-portserviceidsl">2) Define QoS policy (port→ServiceID→SL)</h3> <p>Create <code class="language-plaintext highlighter-rouge">/etc/opensm/qos-policy.conf</code> with policy rules. A pragmatic pattern is to carve the RDMA-CM <strong>port space</strong> into classes and assign SLs per <strong>Service ID range</strong>. Example with three classes:</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># --- Classes ---------------------------------------------------
# Control plane / RPC (low bandwidth, low latency)
service_id 0x0000000000001000-0x0000000000001fff sl 4

# Bulk telemetry / background
service_id 0x0000000000002000-0x0000000000002fff sl 1

# Data path / latency-critical (highest priority)
service_id 0x0000000000003000-0x0000000000003fff sl 6
</code></pre></div></div> <p>Notes:</p> <ul> <li> <p>RDMA-CM encodes <code class="language-plaintext highlighter-rouge">RDMA_PS_TCP</code> + <strong>port</strong> into a 64-bit <strong>Service ID</strong>. Use contiguous <strong>Service ID ranges</strong> to represent your <strong>port ranges</strong>. Confirm the exact mapping in your stack by printing the CM <code class="language-plaintext highlighter-rouge">service_id</code> on connection or using SA queries (see verification below).</p> </li> <li> <p>If you use IPoIB, classification still hinges on <strong>Service ID</strong>, not L3 QoS.</p> </li> </ul> <h3 id="3-map-sls-to-vls-isolation--priority">3) Map SLs to VLs (isolation / priority)</h3> <p>Still in <code class="language-plaintext highlighter-rouge">qos-policy.conf</code>, define SL→VL and VL arbitration so the fabric actually separates traffic:</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># Map each SL to a VL. Keep hot classes on distinct VLs.
sl2vl 0 0
sl2vl 1 1
sl2vl 4 2
sl2vl 6 3

# Basic VL arbitration (weights). Keep highest-priority VLs with more credits.
vlarb_high 0:64 1:64 2:96 3:128
vlarb_low  0:32 1:32 2:48  3:64
</code></pre></div></div> <p>Guidelines:</p> <ul> <li> <p>Keep the number of active VLs modest (4–8). Ensure all HCAs/links support the count you choose.</p> </li> <li> <p>Use distinct VLs for classes that must not interfere. Coalesce low-priority classes on the same VL if you’re VL-limited.</p> </li> </ul> <h3 id="5-apply--persist">5) Apply &amp; persist</h3> <p>Ensure your distro loads the same <code class="language-plaintext highlighter-rouge">opensm.conf</code> and <code class="language-plaintext highlighter-rouge">qos-policy.conf</code> on boot. On systems with multiple HCAs/SM instances, anchor each OpenSM to a GUID/port and reuse the same policy file.</p> <h3 id="verification--troubleshooting">Verification / Troubleshooting</h3> <ul> <li> <p><strong>Check SM picked up QoS:</strong> review <code class="language-plaintext highlighter-rouge">opensm.log</code> for policy parsing, SL2VL, and VLArb tables.</p> </li> <li> <p><strong>Resolve paths with SA:</strong></p> <ul> <li> <p>Get a PathRecord with an explicit <strong>Service ID</strong> to see the returned <strong>SL</strong> (and MTU/rate). Using <code class="language-plaintext highlighter-rouge">saquery</code> (part of infiniband-diags):</p> <div class="language-plaintext highlighter-rouge"> <div class="highlight"><pre class="highlight"><code>  saquery --sgid-to-dgid &lt;sgid&gt;:&lt;dgid&gt; --service-id 0x0000000000003010 --pkey 0x7fff --sl
</code></pre></div> </div> </li> </ul> </li> <li> <p><strong>Confirm on endpoints:</strong> log the CM <code class="language-plaintext highlighter-rouge">service_id</code> and the final QP <strong>SL</strong> your app sees during connection events.</p> </li> <li> <p><strong>Port/VL counters:</strong> use <code class="language-plaintext highlighter-rouge">perfquery</code>/<code class="language-plaintext highlighter-rouge">ibqueryerrors</code> to confirm traffic hits the expected VLs; congestion on the wrong VL hints at SL2VL mismatch.</p> </li> </ul> <h2 id="putting-it-together">Putting It Together</h2> <p>Trace the path: <code class="language-plaintext highlighter-rouge">RDMA-CM port</code> → <code class="language-plaintext highlighter-rouge">Service ID</code> → <code class="language-plaintext highlighter-rouge">Subnet Manager policy</code> → <code class="language-plaintext highlighter-rouge">SL</code> → <code class="language-plaintext highlighter-rouge">VL</code> The path from application to QoS is:</p> <p><code class="language-plaintext highlighter-rouge">RDMA-CM port</code> → <code class="language-plaintext highlighter-rouge">Service ID</code> → <code class="language-plaintext highlighter-rouge">Subnet Manager policy</code> → <code class="language-plaintext highlighter-rouge">SL</code> → <code class="language-plaintext highlighter-rouge">VL</code></p> <p>The application simply binds to a port; RDMA-CM turns that into a Service ID; the SM maps Service IDs to SLs; the fabric maps SLs to VLs. QoS enforcement is transparent to the app.</p> <h2 id="practical-notes">Practical Notes</h2> <ul> <li> <p>With IPoIB: CM addresses look like normal IPs, but they resolve to GIDs under the hood.</p> </li> <li> <p>Without IPoIB: you can still use RDMA-CM with GID-based addresses; port numbers still become Service IDs.</p> </li> <li> <p>If no Service Record matches, the default SL (often 0) is used.</p> </li> </ul> <h2 id="conclusion">Conclusion</h2> <p>RDMA-CM is the bridge between socket-like connection setup and InfiniBand’s fabric-level QoS. It hides GIDs and QP details from the application, while exposing a port number abstraction that the Subnet Manager can map to Service Levels. This is what allows administrators to classify traffic by port ranges and enforce fabric QoS without requiring applications to manipulate QP attributes directly.</p> </div> </article><div id="giscus_thread" style="max-width: 800px; margin: 0 auto;"> <script>let giscusTheme=localStorage.getItem("theme"),giscusAttributes={src:"https://giscus.app/client.js","data-repo":"anku94/giscus-discussions","data-repo-id":"R_kgDOKSSNEA","data-category":"General","data-category-id":"DIC_kwDOKSSNEM4CZPRA","data-mapping":"url","data-strict":"0","data-reactions-enabled":"1","data-emit-metadata":"0","data-input-position":"bottom","data-theme":giscusTheme,"data-lang":"en",crossorigin:"anonymous",async:""},giscusScript=document.createElement("script");Object.entries(giscusAttributes).forEach(([t,e])=>giscusScript.setAttribute(t,e)),document.getElementById("giscus_thread").appendChild(giscusScript);</script> <noscript>Please enable JavaScript to view the <a href="http://giscus.app/?ref_noscript" rel="external nofollow noopener" target="_blank">comments powered by giscus.</a> </noscript> </div> </div> </div> <footer class="fixed-bottom"> <div class="container mt-0"> © Copyright 2025 Ankush Jain. Powered by <a href="https://jekyllrb.com/" target="_blank" rel="external nofollow noopener">Jekyll</a> with <a href="https://github.com/alshedivat/al-folio" rel="external nofollow noopener" target="_blank">al-folio</a> theme. Hosted by <a href="https://pages.github.com/" target="_blank" rel="external nofollow noopener">GitHub Pages</a>. </div> </footer> <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script> <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.1/dist/js/bootstrap.bundle.min.js" integrity="sha256-fgLAgv7fyCGopR/gBNq2iW3ZKIdqIcyshnUULC4vex8=" crossorigin="anonymous"></script> <script src="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/js/mdb.min.js" integrity="sha256-NdbiivsvWt7VYCt6hYNT3h/th9vSTL4EDWeGs5SN3DA=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/masonry-layout@4.2.2/dist/masonry.pkgd.min.js" integrity="sha256-Nn1q/fx0H7SNLZMQ5Hw5JLaTRZp0yILA/FRexe19VdI=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/imagesloaded@4/imagesloaded.pkgd.min.js"></script> <script defer src="/assets/js/masonry.js" type="text/javascript"></script> <script defer src="https://cdn.jsdelivr.net/npm/medium-zoom@1.0.8/dist/medium-zoom.min.js" integrity="sha256-7PhEpEWEW0XXQ0k6kQrPKwuoIomz8R8IYyuU1Qew4P8=" crossorigin="anonymous"></script> <script defer src="/assets/js/zoom.js"></script> <script defer src="https://unpkg.com/bootstrap-table@1.21.4/dist/bootstrap-table.min.js"></script> <script src="/assets/js/no_defer.js?d633890033921b33e0ceb13d22340a9c"></script> <script defer src="/assets/js/common.js?acdb9690d7641b2f8d40529018c71a01"></script> <script defer src="/assets/js/copy_code.js?c9d9dd48933de3831b3ee5ec9c209cac" type="text/javascript"></script> <script async src="https://d1bxh8uas1mnw7.cloudfront.net/assets/embed.js"></script> <script async src="https://badge.dimensions.ai/badge.js"></script> <script type="text/javascript">window.MathJax={tex:{tags:"ams"}};</script> <script defer type="text/javascript" id="MathJax-script" src="https://cdn.jsdelivr.net/npm/mathjax@3.2.0/es5/tex-mml-chtml.js"></script> <script defer src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script> <script async src="https://www.googletagmanager.com/gtag/js?id=G-T2LNMMYJL6"></script> <script>function gtag(){window.dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","G-T2LNMMYJL6");</script> <script type="text/javascript">function progressBarSetup(){"max"in document.createElement("progress")?(initializeProgressElement(),$(document).on("scroll",function(){progressBar.attr({value:getCurrentScrollPosition()})}),$(window).on("resize",initializeProgressElement)):(resizeProgressBar(),$(document).on("scroll",resizeProgressBar),$(window).on("resize",resizeProgressBar))}function getCurrentScrollPosition(){return $(window).scrollTop()}function initializeProgressElement(){let e=$("#navbar").outerHeight(!0);$("body").css({"padding-top":e}),$("progress-container").css({"padding-top":e}),progressBar.css({top:e}),progressBar.attr({max:getDistanceToScroll(),value:getCurrentScrollPosition()})}function getDistanceToScroll(){return $(document).height()-$(window).height()}function resizeProgressBar(){progressBar.css({width:getWidthPercentage()+"%"})}function getWidthPercentage(){return getCurrentScrollPosition()/getDistanceToScroll()*100}const progressBar=$("#progress");window.onload=function(){setTimeout(progressBarSetup,50)};</script> </body> </html>